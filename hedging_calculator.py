import streamlit as st
import numpy as np
import pandas as pd

# ==============================================================================
# è¨­å®šèˆ‡å¸¸æ•¸
# ==============================================================================
# 00631 (å…ƒå¤§å°ç£50æ­£2) çš„æ§“æ¡¿å€æ•¸
LEVERAGE_RATIO = 2.0
# å°æŒ‡å°å°ï¼ˆMTXï¼‰æ¯é»åƒ¹å€¼
MTX_POINT_VALUE = 50 

st.set_page_config(
    page_title="ğŸ“ˆ 00631 å‡ç·šé¿éšªå£æ•¸è¨ˆç®—æ©Ÿ", 
    layout="wide"
)

st.title("ğŸ›¡ï¸ 00631 å‡ç·šé¿éšªå£æ•¸è¨ˆç®—æ©Ÿ")
st.caption(f"æœ¬è¨ˆç®—æ©ŸåŸºæ–¼ **00631ï¼ˆå…©å€æ§“æ¡¿ï¼‰** èˆ‡ **å°æŒ‡å°å°ï¼ˆæ¯é» {MTX_POINT_VALUE} å…ƒï¼‰** é€²è¡Œé¢¨éšªå°æ²–ã€‚")

# ==============================================================================
# å´é‚Šæ¬„è¼¸å…¥ï¼šç­–ç•¥åƒæ•¸
# ==============================================================================
st.sidebar.header("ğŸ“œ é¿éšªç­–ç•¥è¨­å®š")

# 1. å‡ç·šè¨Šè™Ÿ
ma_signal = st.sidebar.selectbox(
    "1. å‡ç·šè¨Šè™Ÿåˆ¤æ–·ï¼ˆé€²å ´/å‡ºå ´æ¢ä»¶ï¼‰",
    options=["æ”¶ç›¤åƒ¹åœ¨å‡ç·šä¸Šæ–¹ (å¤šé ­)", "æ”¶ç›¤åƒ¹åœ¨å‡ç·šä¸‹æ–¹ (ç©ºé ­/é¿éšª)", "ä¿æŒä¸­ç«‹"],
    index=0,
    help="é€™æ˜¯æ±ºå®šæ˜¯å¦å•Ÿå‹•é¿éšªçš„æŠ€è¡“åˆ†æè¨Šè™Ÿã€‚"
)

# 2. ç›®å‰éƒ¨ä½ç‹€æ…‹
current_status = st.sidebar.selectbox(
    "2. æ‚¨ç›®å‰çš„éƒ¨ä½ç‹€æ…‹",
    options=["ç›®å‰æŒæœ‰ 00631 å¤šå€‰ï¼Œæœªé¿éšª", "ç›®å‰å·²é¿éšª (æŒæœ‰ 00631 å¤šå€‰ + å°å°ç©ºå€‰)"],
    index=0,
    help="æ‚¨ç›®å‰æ˜¯å¦å·²ç¶“è™•æ–¼é¿éšªç‹€æ…‹ï¼Ÿ"
)

st.sidebar.markdown("---")
st.sidebar.header("ğŸ“Š æŒå€‰èˆ‡å¸‚å ´æ•¸æ“š")


# ==============================================================================
# ä¸»é é¢è¼¸å…¥ï¼šå¸‚å ´æ•¸æ“š
# ==============================================================================
col1, col2, col3 = st.columns(3)

with col1:
    st.subheader("æŒå€‰éƒ¨ä½")
    holding_lots = st.number_input(
        "00631 æŒæœ‰å¼µæ•¸ (å¼µ)", 
        min_value=1, 
        value=7, 
        step=1,
        help="æ‚¨å¯¦éš›æŒæœ‰çš„ 00631 è‚¡ç¥¨å¼µæ•¸ã€‚"
    )
    price_631 = st.number_input(
        "00631 æœ€æ–°åƒ¹æ ¼ (å…ƒ/è‚¡)", 
        min_value=10.0, 
        value=50.0, 
        step=0.1,
        format="%.2f",
        help="00631 ETF çš„æœ€æ–°æ”¶ç›¤æˆ–å¸‚åƒ¹ã€‚"
    )

with col2:
    st.subheader("å¸‚å ´è³‡è¨Š")
    current_index = st.number_input(
        "å°æŒ‡åŠ æ¬ŠæŒ‡æ•¸ (é»)", 
        min_value=5000, 
        value=19500, 
        step=10,
        help="ç›®å‰å°æŒ‡åŠ æ¬ŠæŒ‡æ•¸çš„é»ä½ã€‚"
    )
    
# ==============================================================================
# è¨ˆç®—é‚è¼¯
# ==============================================================================

# 1. 00631 ç¸½åç›®åƒ¹å€¼ï¼ˆ1Xï¼‰
nominal_value_1x = holding_lots * 1000 * price_631

# 2. å¯¦éš›é¢¨éšªæ•å£ï¼ˆ2X æ§“æ¡¿éƒ¨ä½ï¼‰
effective_exposure = nominal_value_1x * LEVERAGE_RATIO

# 3. å°æŒ‡å°å°åˆç´„åƒ¹å€¼
mtx_contract_value = current_index * MTX_POINT_VALUE

# 4. æ‡‰é¿éšªçš„ç†è«–å£æ•¸ï¼ˆæœªå–æ•´æ•¸ï¼‰
required_lots_float = effective_exposure / mtx_contract_value

# 5. æ±ºå®šå»ºè­°å£æ•¸ï¼ˆé¿éšªé€šå¸¸å»ºè­°è‡³å°‘è¶³é¡ï¼‰
required_lots_ceil = np.ceil(required_lots_float)
required_lots_floor = np.floor(required_lots_float)


# ==============================================================================
# çµæœå±•ç¤º
# ==============================================================================
st.markdown("---")
st.subheader("ğŸ¯ é¿éšªå‹•ä½œèˆ‡å£æ•¸å»ºè­°")

# åˆ¤æ–·çµæœ
action_required = ""
suggested_lots = 0

if ma_signal == "æ”¶ç›¤åƒ¹åœ¨å‡ç·šä¸‹æ–¹ (ç©ºé ­/é¿éšª)":
    if current_status == "ç›®å‰æŒæœ‰ 00631 å¤šå€‰ï¼Œæœªé¿éšª":
        action_required = "ğŸ”´ ç«‹å³å»ºç«‹ç©ºå–®é¿éšª"
        suggested_lots = required_lots_ceil
    elif current_status == "ç›®å‰å·²é¿éšª (æŒæœ‰ 00631 å¤šå€‰ + å°å°ç©ºå€‰)":
        action_required = "ğŸŸ¡ ç¶­æŒé¿éšªç‹€æ…‹ (ç¶­æŒç©ºå–®)"
        suggested_lots = required_lots_ceil
    else: # ä¿æŒä¸­ç«‹
        action_required = "ğŸŸ¢ ç¶­æŒé¿éšªç‹€æ…‹ (ç¶­æŒç©ºå–®)"
        suggested_lots = required_lots_ceil
        
elif ma_signal == "æ”¶ç›¤åƒ¹åœ¨å‡ç·šä¸Šæ–¹ (å¤šé ­)":
    if current_status == "ç›®å‰æŒæœ‰ 00631 å¤šå€‰ï¼Œæœªé¿éšª":
        action_required = "ğŸŸ¢ ç¶­æŒå¤šå€‰ç‹€æ…‹ (ç„¡é ˆé¿éšª)"
        suggested_lots = 0
    elif current_status == "ç›®å‰å·²é¿éšª (æŒæœ‰ 00631 å¤šå€‰ + å°å°ç©ºå€‰)":
        action_required = "ğŸŸ¢ å¹³å€‰é¿éšªç©ºå–® (è§£é™¤é¿éšª)"
        # é€™è£¡å»ºè­°çš„å£æ•¸æ˜¯å¹³å€‰æ•¸é‡ï¼Œæˆ‘å€‘å‡è¨­å¹³å€‰æ•¸é‡ç­‰æ–¼ç•¶åˆå»ºè­°çš„å»ºå€‰æ•¸é‡
        suggested_lots = np.ceil(required_lots_float) 
    else: # ä¿æŒä¸­ç«‹
        action_required = "ğŸŸ¡ ä¿æŒä¸­ç«‹ç‹€æ…‹ (ç„¡é ˆé¿éšª)"
        suggested_lots = 0

else: # ä¿æŒä¸­ç«‹ï¼ˆç•¶å‡ç·šåˆ¤æ–·æ¨¡ç³Šæ™‚ï¼‰
    action_required = "ğŸŸ¡ å¸‚å ´åˆ¤æ–·ä¸æ˜ï¼Œå»ºè­°ç¶­æŒç¾ç‹€æˆ–ä½¿ç”¨æ›´é•·é€±æœŸçš„å‡ç·šã€‚"
    suggested_lots = np.ceil(required_lots_float) if current_status == "ç›®å‰å·²é¿éšª (æŒæœ‰ 00631 å¤šå€‰ + å°å°ç©ºå€‰)" else 0


# è¼¸å‡ºçµæœ
if "ğŸ”´" in action_required:
    st.error(f"### {action_required}")
elif "ğŸŸ¢" in action_required:
    st.success(f"### {action_required}")
else:
    st.warning(f"### {action_required}")

st.markdown("---")

col4, col5, col6, col7 = st.columns(4)

col4.metric(
    "ğŸ“Š å¯¦éš›é¢¨éšªæ•å£ (å…ƒ)",
    f"{effective_exposure:,.0f} å…ƒ",
    help=f"æ‚¨æŒæœ‰çš„ {LEVERAGE_RATIO} å€æ§“æ¡¿éƒ¨ä½çš„ç¸½åƒ¹å€¼ã€‚"
)

col5.metric(
    f"ğŸ› ï¸ å°å°åˆç´„åƒ¹å€¼ (å…ƒ)",
    f"{mtx_contract_value:,.0f} å…ƒ",
    help="ç›®å‰æŒ‡æ•¸é»ä½ä¸‹ï¼Œå–®ä¸€å£å°å°çš„ç¸½åç›®åƒ¹å€¼ã€‚"
)

col6.metric(
    "ğŸ”¬ ç†è«–é¿éšªå£æ•¸ (æµ®é»æ•¸)",
    f"{required_lots_float:.2f} å£",
    help="æ ¹æ“šé¢¨éšªæ•å£ç²¾ç®—å‡ºçš„ç†è«–å£æ•¸ã€‚"
)

if suggested_lots > 0:
    col7.metric(
        "ğŸ”¥ å»ºè­°æ“ä½œå£æ•¸ (å£)",
        f"{int(suggested_lots):,}",
        help="å¯¦éš›æ“ä½œæ™‚ï¼Œå»ºè­°å››æ¨äº”å…¥ï¼ˆæˆ–ç„¡æ¢ä»¶é€²ä½ï¼‰è‡³æ•´æ•¸å£ã€‚"
    )
elif "å¹³å€‰" in action_required:
    col7.metric(
        "ğŸ”¥ å»ºè­°æ“ä½œå£æ•¸ (å£)",
        f"å¹³å€‰ {int(suggested_lots):,} å£",
        help="å»ºè­°å¹³å€‰çš„å£æ•¸ã€‚"
    )
else:
    col7.metric("ğŸ”¥ å»ºè­°æ“ä½œå£æ•¸ (å£)", "0")

st.markdown("---")
st.info(f"**ğŸ’¡ é¿éšªé‚è¼¯æ‘˜è¦ï¼š**\n\n1. æ‚¨çš„ {holding_lots} å¼µ 00631 ç¸½é¢¨éšªæ•å£ç´„ç‚º **{effective_exposure:,.0f} å…ƒ**ã€‚\n2. ç”±æ–¼å°å°åˆç´„åƒ¹å€¼ç´„ç‚º **{mtx_contract_value:,.0f} å…ƒ**ï¼Œæ‚¨ç†è«–ä¸Šæ‡‰å»ºç«‹ **{required_lots_float:.2f} å£** ç©ºå–®æ‰èƒ½å®Œå…¨å°æ²–ã€‚\n3. æˆ‘å€‘å»ºè­°æ¡ç”¨ **ç„¡æ¢ä»¶é€²ä½**ï¼Œå³æ“ä½œ **{int(suggested_lots):,} å£** ä¾†ç¢ºä¿è¶³é¡å°æ²–ã€‚\n\n**é¢¨éšªæç¤ºï¼š** å¯¦éš›é¿éšªæ‡‰è€ƒæ…®äº¤æ˜“æˆæœ¬ã€è¿½è¹¤èª¤å·®ã€åŠæ™‚æ€§ç­‰å› ç´ ã€‚")
